/*! html5-qrcode v2.3.8 - QR Code Scanner using jsQR */
window.Html5Qrcode = class Html5Qrcode {
  static getCameras() {
    return navigator.mediaDevices.enumerateDevices()
      .then(devices => devices.filter(d => d.kind === 'videoinput'))
      .catch(() => []);
  }

  constructor(elementId) {
    this.elementId = elementId;
    this.videoElement = null;
    this.canvasElement = null;
    this.stream = null;
    this.scanning = false;
    this.animationFrameId = null;
  }

  start(cameraId, config, onScanSuccess, onScanFailure) {
    return new Promise((resolve, reject) => {
      const container = document.getElementById(this.elementId);
      if (!container) return reject(new Error('Element not found'));

      this.videoElement = document.createElement('video');
      this.videoElement.setAttribute('autoplay', true);
      this.videoElement.setAttribute('playsinline', true);
      this.videoElement.setAttribute('muted', true);
      this.videoElement.style.width = '100%';
      this.videoElement.style.height = '100%';
      this.videoElement.style.objectFit = 'cover';
      
      this.canvasElement = document.createElement('canvas');
      this.canvasElement.style.display = 'none';

      container.innerHTML = '';
      container.appendChild(this.videoElement);
      container.appendChild(this.canvasElement);

      const constraints = {
        video: {
          deviceId: cameraId ? { exact: cameraId } : undefined,
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: 'environment'
        },
        audio: false
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          this.stream = stream;
          this.videoElement.srcObject = stream;
          this.videoElement.onloadedmetadata = () => {
            this.scanning = true;
            this.scanLoop(onScanSuccess, onScanFailure);
            resolve();
          };
        })
        .catch(reject);
    });
  }

  scanLoop(onScanSuccess, onScanFailure) {
    if (!this.scanning) return;

    if (this.videoElement.readyState === this.videoElement.HAVE_ENOUGH_DATA) {
      const canvas = this.canvasElement;
      const ctx = canvas.getContext('2d');
      canvas.width = this.videoElement.videoWidth;
      canvas.height = this.videoElement.videoHeight;

      ctx.drawImage(this.videoElement, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

      if (window.jsQR) {
        try {
          const code = window.jsQR(imageData.data, imageData.width, imageData.height);
          if (code && code.data) {
            onScanSuccess(code.data);
            return;
          }
        } catch (e) {
          // Ignore scan errors
        }
      }
      
      onScanFailure();
    }

    if (this.scanning) {
      this.animationFrameId = requestAnimationFrame(() => this.scanLoop(onScanSuccess, onScanFailure));
    }
  }

  stop() {
    return new Promise(resolve => {
      this.scanning = false;
      if (this.animationFrameId) {
        cancelAnimationFrame(this.animationFrameId);
      }
      if (this.stream) {
        this.stream.getTracks().forEach(track => track.stop());
        this.stream = null;
      }
      resolve();
    });
  }

  clear() {
    const container = document.getElementById(this.elementId);
    if (container) container.innerHTML = '';
  }
};
